<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Simulador de Radar y Reporte T√°ctico (Tiempo Real)</title>
  <style>
    body{background:#000;color:#fff;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;text-align:center;margin:0;height:100vh;overflow:hidden}
    h1{color:#90ee90;margin:14px 0}
    button{padding:6px 10px;font-size:13px;border:1px solid rgba(255,255,255,.06);border-radius:6px;cursor:pointer;background:rgba(26,92,26,.95);color:#fff;margin:4px;transition:background .12s,transform .06s}
    button:hover{background:rgba(40,122,40,.95);transform:translateY(-1px)}
    .btn-compact{padding:5px 8px;font-size:12px;border-radius:5px}
    .btn-highlight{border:1px solid yellow;background:rgba(255,215,0,.3)}
    .panel{position:absolute;background:rgba(10,20,10,.85);padding:12px;border-radius:10px;border:1px solid #2f6b2f;backdrop-filter: blur(2px)}
    .panel-header{font-weight:bold;color:#90ee90;text-align:center;margin-bottom:8px}
    .row{display:flex;gap:6px;flex-wrap:wrap;justify-content:center}
    .info{font:12px monospace;color:#ddd}
    canvas{display:block;position:absolute;top:0;left:0;width:100%;height:100%}
    .pill{display:inline-block;padding:2px 6px;border:1px dashed #555;border-radius:6px;font:11px monospace;color:#bbb;margin-left:6px}
    .badge{display:inline-block;padding:2px 6px;border-radius:6px;background:#1f421f;font:11px monospace}
    .warning{color:#ffb000}
    .danger{color:#ff6363}
    .ok{color:#7fff7f}
  </style>
</head>
<body>
  <h1>Simulador de Radar y Reporte T√°ctico</h1>
  <div class="row">
    <button id="simButton" class="btn-compact">Abrir Panel Instructor</button>
    <button id="alumnoButton" class="btn-compact">Abrir Panel Alumno</button>
    <span class="pill">Click derecho = Regla</span>
  </div>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    // =========================
    // Firebase
    // =========================
    const firebaseConfig = {
      apiKey: "AIzaSyDiuQsBaCoPrpjEfhYKgY649GJ5iXd0huw",
      authDomain: "odi-gci-simulador.firebaseapp.com",
      databaseURL: "https://odi-gci-simulador-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "odi-gci-simulador",
      storageBucket: "odi-gci-simulador.firebasestorage.app",
      messagingSenderId: "188901394065",
      appId: "1:188901394065:web:6ab4d0610cfd61d3582130"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // =========================
    // Estado compartido
    // =========================
    const NM_TO_KM = 1.852;
    const KMH_TO_KNOTS = 0.539957;
    const FT_TO_M = 0.3048;

    const INITIAL_PLANES = [
      { name:"R1", originalName:"R1", x:-30, y:0,    heading:0,  targetHeading:0,  speedKmh:450, targetSpeedKmh:450, altitude:20000, targetAltitude:20000, maxTurnRate:2, ghosts:[], lastDetected:0 },
      { name:"R2", originalName:"R2", x:30,  y:0,    heading:45, targetHeading:45, speedKmh:450, targetSpeedKmh:450, altitude:21000, targetAltitude:21000, maxTurnRate:2, ghosts:[], lastDetected:0 },
      { name:"R3", originalName:"R3", x:0,   y:-40,  heading:90, targetHeading:90, speedKmh:500, targetSpeedKmh:500, altitude:22000, targetAltitude:22000, maxTurnRate:2.5, ghosts:[], lastDetected:0 }
    ];

    let sharedState = {
      planes: JSON.parse(JSON.stringify(INITIAL_PLANES)),
      paused: true,
      selectedPlanes: [],
      planeRoles: { "R1":"Friend","R2":"Bandit","R3":"Friend" },
      studentPairings: [],       // [{plane1Name, plane2Name, distanceNM, distanceKM, relativeHeading, altitudeDiff}]
      windSpeedKmh: 0,
      windDirectionDeg: 0,
      isMetric: false,
      missiles: [],              // [{id,name,x,y,speedKmh,launcher,target,maxRangeKM,traveledKM,launchedAt,status}]
      radarSweepAngle: 0,
      radarSweepSpeedDegPerSec: 10,
      predictionTimeMinutes: 5,
      radarSweepEnabled: true,
      displayMode: 'digital',
      radarFailureActive: false
    };

    function sendUpdate() { db.ref("simulador/state").set(sharedState); }
    db.ref("simulador/state").on("value", snap => {
      const newState = snap.val();
      if (newState) sharedState = newState;
    });

    // =========================
    // Ventanas
    // =========================
    document.getElementById("simButton").onclick    = () => openRadarWindow(true);
    document.getElementById("alumnoButton").onclick = () => openRadarWindow(false);

    function openRadarWindow(isInstructor) {
      const popupName = isInstructor ? "Instructor" : "Alumno";
      const popup = window.open("", popupName, "width=1400,height=900,resizable=yes,scrollbars=yes");
      if (!popup) { alert("‚ö†Ô∏è Habilita los pop-ups"); return; }

      const doc = popup.document;
      doc.title = `Radar ${popupName}`;
      doc.body.innerHTML = `
        <canvas id="popup-canvas"></canvas>

        ${isInstructor ? `
        <div id="panel-planes" class="panel" style="top:10px;left:10px;width:280px;"></div>
        <div id="panel-global" class="panel" style="bottom:10px;left:10px;width:340px;"></div>
        <div id="panel-eventos" class="panel" style="bottom:10px;right:10px;width:360px;"></div>
        ` : `
        <div id="panel-alumno" class="panel" style="bottom:10px;left:10px;width:360px;"></div>
        <div id="panel-pairing" class="panel" style="top:10px;right:10px;width:320px;"></div>
        <div id="missile-indicator" class="panel" style="top:10px;left:10px;width:260px;display:none;background:rgba(60,0,0,.8);border-color:#7a0000"></div>
        `}
      `;

      // ===== Canvas =====
      const canvas = doc.getElementById("popup-canvas");
      const ctx = canvas.getContext("2d");
      let centerX, centerY, zoom = 1, offsetX = 0, offsetY = 0;

      function resizeCanvas(){
        canvas.width = popup.innerWidth;
        canvas.height = popup.innerHeight;
        centerX = canvas.width/2;
        centerY = canvas.height/2;
      }
      resizeCanvas();
      popup.addEventListener("resize", resizeCanvas);

      // ===== Clases/Utils =====
      class Plane {
        constructor(d){ this.data=d; this._ghostTimer=0; }
        update(dt){
          if (sharedState.paused) return;
          const s = this.data;
          const sec = dt/1000;

          const accel = 50;
          if (s.speedKmh < s.targetSpeedKmh) s.speedKmh = Math.min(s.speedKmh + accel*sec, s.targetSpeedKmh);
          if (s.speedKmh > s.targetSpeedKmh) s.speedKmh = Math.max(s.speedKmh - accel*sec, s.targetSpeedKmh);

          let diff = (s.targetHeading - s.heading + 360) % 360;
          if (diff > 180) diff -= 360;
          const maxTurn = s.maxTurnRate * sec;
          s.heading = (s.heading + Math.max(-maxTurn, Math.min(maxTurn, diff)) + 360) % 360;

          // Viento
          const windNMps = (sharedState.windSpeedKmh / NM_TO_KM)/3600;
          const windX = Math.cos((sharedState.windDirectionDeg-90)*Math.PI/180) * windNMps * sec;
          const windY = Math.sin((sharedState.windDirectionDeg-90)*Math.PI/180) * windNMps * sec;

          const moveNM = (s.speedKmh / NM_TO_KM)/3600 * sec;
          s.x += Math.cos((s.heading-90)*Math.PI/180)*moveNM + windX;
          s.y += Math.sin((s.heading-90)*Math.PI/180)*moveNM + windY;

          // Trail
          this._ghostTimer += dt;
          if (this._ghostTimer > 2000) {
            s.ghosts.push({x:s.x,y:s.y});
            if (s.ghosts.length>10) s.ghosts.shift();
            this._ghostTimer = 0;
          }
        }
        draw(){
          const s = this.data;
          const px = centerX + offsetX + s.x * zoom * 20;
          const py = centerY + offsetY + s.y * zoom * 20;

          // Trail
          const n = s.ghosts.length;
          for (let i=0;i<n;i++){
            const g = s.ghosts[i];
            const a = (i+1)/n * 0.5;
            ctx.fillStyle = `rgba(0,255,0,${a})`;
            ctx.fillRect(centerX+offsetX+g.x*zoom*20-2, centerY+offsetY+g.y*zoom*20-2, 4,4);
          }

          // Contacto
          const role = sharedState.planeRoles[s.originalName]||"Neutral";
          ctx.strokeStyle = role==="Friend" ? "dodgerblue" : role==="Bandit" ? "red" : "lime";
          ctx.lineWidth = 2;
          const hdg = (s.heading - 90)*Math.PI/180;
          ctx.beginPath();
          ctx.moveTo(px + Math.cos(hdg+Math.PI*0.75)*8, py + Math.sin(hdg+Math.PI*0.75)*8);
          ctx.lineTo(px + Math.cos(hdg)*16,             py + Math.sin(hdg)*16);
          ctx.lineTo(px + Math.cos(hdg-Math.PI*0.75)*8, py + Math.sin(hdg-Math.PI*0.75)*8);
          ctx.closePath(); ctx.stroke();

          // Hoja de datos
          ctx.fillStyle = "#fff"; ctx.font = "12px monospace"; ctx.textAlign="left";
          ctx.fillText(`${s.name}`, px+14, py-6);
          const alt = sharedState.isMetric ? `${(s.altitude*FT_TO_M)|0} m` : `${s.altitude|0} ft`;
          const spd = sharedState.isMetric ? `${s.speedKmh|0} km/h` : `${(s.speedKmh*KMH_TO_KNOTS)|0} kts`;
          ctx.fillText(`${alt}  ${spd}`, px+14, py+10);

          // Selecci√≥n + Predicci√≥n
          if (sharedState.selectedPlanes.includes(s.originalName)) {
            ctx.strokeStyle="yellow"; ctx.strokeRect(px-10, py-10, 20,20);
            const predSec = (sharedState.predictionTimeMinutes||0)*60;
            if (predSec>0){
              const distNM = (s.speedKmh/NM_TO_KM)/3600 * predSec;
              const tx = s.x + Math.cos(hdg)*distNM;
              const ty = s.y + Math.sin(hdg)*distNM;
              const tpx = centerX + offsetX + tx*zoom*20;
              const tpy = centerY + offsetY + ty*zoom*20;
              ctx.setLineDash([5,5]); ctx.strokeStyle="cyan";
              ctx.beginPath(); ctx.moveTo(px,py); ctx.lineTo(tpx,tpy); ctx.stroke(); ctx.setLineDash([]);
            }
          }

          if (s._hit) {
            ctx.fillStyle='red'; ctx.font='20px monospace'; ctx.fillText('X', px-6, py-16);
          }
        }
      }

      // ===== Radar sweep y rejilla =====
      function drawScope(dt){
        ctx.fillStyle = "#000"; ctx.fillRect(0,0,canvas.width,canvas.height);

        // Falla de radar vista Alumno
        if (!isInstructor && sharedState.radarFailureActive) {
          // nieve + mensaje
          for (let i=0;i<220;i++){
            ctx.fillStyle = `rgba(0,255,0,${Math.random()*0.3})`;
            ctx.beginPath();
            ctx.arc(Math.random()*canvas.width, Math.random()*canvas.height, Math.random()*2, 0, Math.PI*2);
            ctx.fill();
          }
          ctx.font = 'bold 80px monospace'; ctx.fillStyle='#f33'; ctx.textAlign='center';
          ctx.shadowColor='#f33'; ctx.shadowBlur=16;
          ctx.fillText("NO SIGNAL", canvas.width/2, canvas.height/2);
          ctx.shadowBlur=0;
          return;
        }

        // c√≠rculos de distancia
        const MAX_RANGE_NM = 100, ARC_STEP_NM = 10;
        ctx.strokeStyle = '#2f2f2f'; ctx.lineWidth=1; ctx.textAlign='center';
        for (let r=ARC_STEP_NM;r<=MAX_RANGE_NM;r+=ARC_STEP_NM){
          ctx.beginPath();
          ctx.arc(centerX+offsetX, centerY+offsetY, r*zoom*20, 0, Math.PI*2);
          ctx.stroke();
          ctx.fillStyle='#6f6f6f'; ctx.font='10px monospace';
          const label = sharedState.isMetric ? `${(r*NM_TO_KM).toFixed(0)} km` : `${r} NM`;
          ctx.fillText(label, centerX+offsetX, centerY+offsetY - r*zoom*20 - 4);
        }
        // radiales
        for (let a=0;a<360;a+=30){
          const ang = (a-90)*Math.PI/180;
          ctx.beginPath();
          ctx.moveTo(centerX+offsetX, centerY+offsetY);
          ctx.lineTo(centerX+offsetX + Math.cos(ang)*MAX_RANGE_NM*zoom*20,
                     centerY+offsetY + Math.sin(ang)*MAX_RANGE_NM*zoom*20);
          ctx.stroke();
        }

        // barrido
        if (sharedState.radarSweepEnabled) {
          sharedState.radarSweepAngle = (sharedState.radarSweepAngle + sharedState.radarSweepSpeedDegPerSec*(dt/1000))%360;
          const sweepAngleRad = sharedState.radarSweepAngle * Math.PI/180;
          const r = Math.max(canvas.width, canvas.height);
          ctx.save(); ctx.translate(centerX+offsetX, centerY+offsetY); ctx.rotate(sweepAngleRad);
          const grad = ctx.createRadialGradient(0,0,0,0,0,r);
          grad.addColorStop(0,'rgba(255,165,0,0.05)');
          grad.addColorStop(0.5,'rgba(255,165,0,0.15)');
          grad.addColorStop(1,'rgba(255,165,0,0.3)');
          ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,r,0,Math.PI/8); ctx.closePath();
          ctx.fillStyle=grad; ctx.fill(); ctx.restore();
        }
      }

      // ===== Misiles =====
      function createMissile(launcherOriginal, targetOriginal){
        const L = sharedState.planes.find(p=>p.originalName===launcherOriginal);
        const T = sharedState.planes.find(p=>p.originalName===targetOriginal);
        if (!L || !T) return;
        const m = {
          id: "DART-"+Date.now(),
          name: "DART",
          x: L.x, y: L.y, speedKmh: 2500,
          launcher: L.originalName, target: T.originalName,
          maxRangeKM: 90, traveledKM: 0, launchedAt: Date.now(), status: "flying"
        };
        sharedState.missiles.push(m); sendUpdate();
      }

      function updateMissiles(dt){
        const sec = dt/1000;
        for (const m of sharedState.missiles){
          if (m.status!=="flying") continue;
          const T = sharedState.planes.find(p=>p.originalName===m.target);
          if (!T){ m.status="timeout"; continue; }
          const speedNMps = (m.speedKmh / NM_TO_KM)/3600;
          const dx = T.x - m.x, dy = T.y - m.y;
          const distNM = Math.hypot(dx,dy);
          if (distNM===0){ m.x=T.x; m.y=T.y; m.status="splash"; markPlaneHit(T.originalName); continue; }
          const step = speedNMps*sec;
          const r = Math.min(1, step/distNM);
          m.x += dx*r; m.y += dy*r;
          m.traveledKM += step * NM_TO_KM;
          const newDistNM = Math.hypot(T.x-m.x, T.y-m.y);
          if (newDistNM<=0.15){ m.status="splash"; markPlaneHit(T.originalName); }
          if (m.traveledKM>=m.maxRangeKM){ m.status="timeout"; }
        }
        // limpiar timeouts viejos opcional
      }

      function drawMissiles(){
        const indicator = doc.getElementById("missile-indicator");
        let showPanel = false, panelHTML = "";
        for (const m of sharedState.missiles){
          const px = centerX + offsetX + m.x*zoom*20;
          const py = centerY + offsetY + m.y*zoom*20;
          ctx.fillStyle = m.status==="flying" ? "#ffcc00" : (m.status==="splash" ? "red" : "gray");
          ctx.beginPath(); ctx.arc(px,py,4,0,Math.PI*2); ctx.fill();
          ctx.fillStyle="#fff"; ctx.font="10px monospace"; ctx.fillText(m.name, px+8, py);

          if (!isInstructor){
            if (m.status==="flying"){
              const T = sharedState.planes.find(p=>p.originalName===m.target);
              if (T){
                const distNM = Math.hypot(T.x - m.x, T.y - m.y);
                const distKM = distNM * NM_TO_KM;
                panelHTML = `<div class="panel-header danger">Misil en camino</div>
                             <div class="info">Objetivo: <b>${T.name}</b></div>
                             <div class="info">Distancia: <b>${distKM.toFixed(1)} km</b></div>`;
                showPanel = true;
              }
            } else if (m.status==="splash"){
              panelHTML = `<div class="panel-header ok">Splash confirmado</div>
                           <div class="info">Objetivo: <b>${m.target}</b></div>`;
              showPanel = true;
            } else if (m.status==="timeout"){
              panelHTML = `<div class="panel-header warning">Misil agot√≥ alcance</div>
                           <div class="info">Objetivo: <b>${m.target}</b></div>`;
              showPanel = true;
            }
          }
        }
        if (indicator){
          indicator.style.display = showPanel ? "block" : "none";
          if (showPanel) indicator.innerHTML = panelHTML;
        }
      }

      function markPlaneHit(originalName){
        const p = sharedState.planes.find(pl=>pl.originalName===originalName);
        if (p) p._hit = true;
      }

      // ===== Empareo (BRAA) =====
      function computePairMetrics(p1, p2){
        const dx = p2.x - p1.x, dy = p2.y - p1.y;
        const distanceNM = Math.hypot(dx,dy);
        const distanceKM = distanceNM * NM_TO_KM;
        let brg = Math.atan2(dx, -dy) * 180 / Math.PI;
        brg = (brg + 360) % 360;
        const altDiff = p2.altitude - p1.altitude;
        return { distanceNM, distanceKM, relativeHeading: brg, altitudeDiff: altDiff };
      }

      function drawPairLines(){
        ctx.font = '12px monospace'; ctx.textAlign='center';
        for (const pair of sharedState.studentPairings){
          const p1 = sharedState.planes.find(p=>p.originalName===pair.plane1Name);
          const p2 = sharedState.planes.find(p=>p.originalName===pair.plane2Name);
          if (!p1 || !p2) continue;
          const x1 = centerX+offsetX + p1.x*zoom*20;
          const y1 = centerY+offsetY + p1.y*zoom*20;
          const x2 = centerX+offsetX + p2.x*zoom*20;
          const y2 = centerY+offsetY + p2.y*zoom*20;

          ctx.strokeStyle='#fff'; ctx.lineWidth=1;
          ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();

          const midx=(x1+x2)/2, midy=(y1+y2)/2;
          const head = String(Math.round(pair.relativeHeading)).padStart(3,'0')+'¬∞';
          const dist = sharedState.isMetric ? pair.distanceKM.toFixed(1)+' KM' : pair.distanceNM.toFixed(1)+' NM';
          const alt  = sharedState.isMetric ? (pair.altitudeDiff*FT_TO_M).toFixed(0)+' m' : pair.altitudeDiff.toFixed(0)+' ft';

          const txt = `${head} / ${dist} / ŒîALT ${alt}`;
          const w = ctx.measureText(txt).width + 10;
          ctx.fillStyle='rgba(0,0,0,.5)';
          ctx.fillRect(midx-w/2, midy-18, w, 16);
          ctx.fillStyle='#fff'; ctx.fillText(txt, midx, midy-6);
        }
      }

      // ===== Regla (click derecho) =====
      let rulerStart = null, rulerEnd = null, measuring = false;
      canvas.addEventListener("contextmenu", e => e.preventDefault());
      canvas.addEventListener("mousedown", e=>{
        if (e.button===2){ // right
          measuring = true;
          rulerStart = { x:e.clientX, y:e.clientY };
          rulerEnd   = { x:e.clientX, y:e.clientY };
        }
      });
      canvas.addEventListener("mousemove", e=>{
        if (measuring) rulerEnd = { x:e.clientX, y:e.clientY };
      });
      canvas.addEventListener("mouseup", e=>{
        if (e.button===2){ measuring=false; }
      });

      function drawRuler(){
        if (!rulerStart || !rulerEnd) return;
        const sx=rulerStart.x, sy=rulerStart.y, ex=rulerEnd.x, ey=rulerEnd.y;
        ctx.strokeStyle='cyan'; ctx.lineWidth=1;
        ctx.beginPath(); ctx.moveTo(sx,sy); ctx.lineTo(ex,ey); ctx.stroke();

        // convertir screen -> NM
        const startX_nm = (sx - centerX - offsetX)/(zoom*20);
        const startY_nm = (sy - centerY - offsetY)/(zoom*20);
        const endX_nm   = (ex - centerX - offsetX)/(zoom*20);
        const endY_nm   = (ey - centerY - offsetY)/(zoom*20);
        const dx_nm=endX_nm-startX_nm, dy_nm=endY_nm-startY_nm;
        const distNM = Math.hypot(dx_nm, dy_nm);
        const distKM = distNM * NM_TO_KM;
        let brg = Math.atan2(dx_nm, -dy_nm) * 180/Math.PI; brg=(brg+360)%360;

        const label = sharedState.isMetric ?
          `DIST: ${distKM.toFixed(1)} KM  BRG: ${Math.round(brg)}¬∞` :
          `DIST: ${distNM.toFixed(1)} NM  BRG: ${Math.round(brg)}¬∞`;

        const midx=(sx+ex)/2, midy=(sy+ey)/2;
        ctx.fillStyle='cyan'; ctx.font='14px monospace'; ctx.textAlign='center';
        ctx.fillText(label, midx, midy-8);
      }

      // ===== UI =====
      function updateUI(){
        if (isInstructor){
          // Lista de aviones / selecci√≥n
          const pPanel = doc.getElementById("panel-planes");
          pPanel.innerHTML = `<div class="panel-header">Aviones</div>`;
          sharedState.planes.forEach(p=>{
            const b = doc.createElement("button");
            b.className="btn-compact";
            b.textContent = `${p.name} (${sharedState.planeRoles[p.originalName]||'Neutral'})`;
            if (sharedState.selectedPlanes.includes(p.originalName)) b.classList.add("btn-highlight");
            b.onclick=()=>{
              const i = sharedState.selectedPlanes.indexOf(p.originalName);
              if (i>=0) sharedState.selectedPlanes.splice(i,1);
              else {
                if (sharedState.selectedPlanes.length>=3) return alert("M√°x. 3 seleccionados");
                sharedState.selectedPlanes.push(p.originalName);
              }
              sendUpdate(); updateUI();
            };
            pPanel.appendChild(b);
          });

          // Panel global: sim, medidas, radar, predicci√≥n, misiles, viento, roles, edici√≥n r√°pida del seleccionado
          const g = doc.getElementById("panel-global");
          g.innerHTML = `<div class="panel-header">Controles Globales</div>`;

          const start = btn("‚ñ∂Ô∏è Iniciar","‚è∏Ô∏è Pausar", !sharedState.paused);
          start.onclick=()=>{ sharedState.paused=!sharedState.paused; sendUpdate(); };
          g.appendChild(start);

          const row1 = divRow();
          const metric  = toggleBtn("M√©trico", sharedState.isMetric, ()=>{sharedState.isMetric=true; sendUpdate();});
          const imperial= toggleBtn("Imperial",!sharedState.isMetric, ()=>{sharedState.isMetric=false; sendUpdate();});
          row1.appendChild(metric); row1.appendChild(imperial); g.appendChild(row1);

          const row2 = divRow();
          const analog = toggleBtn("Anal√≥gico", sharedState.displayMode==='analog', ()=>{sharedState.displayMode='analog'; sendUpdate();});
          const digital= toggleBtn("Digital",   sharedState.displayMode==='digital',()=>{sharedState.displayMode='digital';sendUpdate();});
          const haz    = toggleBtn(sharedState.radarSweepEnabled?"Haz ON":"Haz OFF", sharedState.radarSweepEnabled, ()=>{sharedState.radarSweepEnabled=!sharedState.radarSweepEnabled; sendUpdate();});
          row2.appendChild(analog); row2.appendChild(digital); row2.appendChild(haz); g.appendChild(row2);

          const row3 = divRow();
          const menos = smallBtn("- Pred", ()=>{sharedState.predictionTimeMinutes=Math.max(0,(sharedState.predictionTimeMinutes||0)-1); sendUpdate();});
          const mas   = smallBtn("+ Pred", ()=>{sharedState.predictionTimeMinutes=Math.min(60,(sharedState.predictionTimeMinutes||0)+1); sendUpdate();});
          const pred  = spanInfo(`Pred: <b>${sharedState.predictionTimeMinutes} min</b>`);
          row3.appendChild(menos); row3.appendChild(mas); row3.appendChild(pred); g.appendChild(row3);

          // Lanzamiento de misil desde el 1er seleccionado a un objetivo
          if (sharedState.selectedPlanes.length>0){
            const srcName = sharedState.selectedPlanes[0];
            const src = sharedState.planes.find(p=>p.originalName===srcName);
            const rowM = divRow();
            const sel = doc.createElement("select");
            sel.className="btn-compact";
            sel.innerHTML = `<option value="">Objetivo</option>` +
              sharedState.planes.filter(p=>p.originalName!==srcName).map(p=>`<option value="${p.originalName}">${p.name}</option>`).join("");
            const fire = smallBtn("üöÄ Lanzar", ()=>{
              if (!sel.value) return alert("Elige objetivo");
              createMissile(srcName, sel.value);
              sendUpdate();
            });
            rowM.appendChild(spanInfo(`Lanzar desde <b>${src.name}</b>`));
            rowM.appendChild(sel); rowM.appendChild(fire); g.appendChild(rowM);
          }

          // Viento
          const ev = doc.getElementById("panel-eventos");
          ev.innerHTML = `<div class="panel-header">Eventos</div>`;
          const windR = divRow();
          const ws = inputNum(sharedState.isMetric?sharedState.windSpeedKmh:Math.round(sharedState.windSpeedKmh*KMH_TO_KNOTS), 0, 500, v=>{
            sharedState.windSpeedKmh = sharedState.isMetric ? Number(v) : Number(v)/KMH_TO_KNOTS; sendUpdate();
          }, "Vel");
          const wd = inputNum(sharedState.windDirectionDeg, 0, 360, v=>{ sharedState.windDirectionDeg=Number(v)%360; sendUpdate(); }, "Dir¬∞");
          const wr = smallBtn("üå™Ô∏è Aleatorio", ()=>{
            sharedState.windSpeedKmh = Math.random()*80;
            sharedState.windDirectionDeg = Math.floor(Math.random()*360);
            sendUpdate();
          });
          windR.appendChild(ws); windR.appendChild(wd); windR.appendChild(wr); ev.appendChild(windR);

          const failR = divRow();
          const fail = toggleBtn("Falla Radar", sharedState.radarFailureActive, ()=>{sharedState.radarFailureActive=!sharedState.radarFailureActive; sendUpdate();});
          failR.appendChild(fail); ev.appendChild(failR);

        } else {
          // Alumno
          const pa = doc.getElementById("panel-alumno");
          pa.innerHTML = `<div class="panel-header">Controles de Visibilidad</div>`;

          const r1 = divRow();
          r1.appendChild(toggleBtn("M√©trico", sharedState.isMetric, ()=>{sharedState.isMetric=true; sendUpdate();}));
          r1.appendChild(toggleBtn("Imperial", !sharedState.isMetric, ()=>{sharedState.isMetric=false; sendUpdate();}));
          pa.appendChild(r1);

          const r2 = divRow();
          r2.appendChild(toggleBtn("Anal√≥gico", sharedState.displayMode==='analog', ()=>{sharedState.displayMode='analog'; sendUpdate();}));
          r2.appendChild(toggleBtn("Digital",   sharedState.displayMode==='digital',()=>{sharedState.displayMode='digital';sendUpdate();}));
          r2.appendChild(toggleBtn(sharedState.radarSweepEnabled?"Haz ON":"Haz OFF", sharedState.radarSweepEnabled, ()=>{sharedState.radarSweepEnabled=!sharedState.radarSweepEnabled; sendUpdate();}));
          pa.appendChild(r2);

          const r3 = divRow();
          r3.appendChild(smallBtn("- Pred", ()=>{sharedState.predictionTimeMinutes=Math.max(0,(sharedState.predictionTimeMinutes||0)-1); sendUpdate();}));
          r3.appendChild(smallBtn("+ Pred", ()=>{sharedState.predictionTimeMinutes=Math.min(60,(sharedState.predictionTimeMinutes||0)+1); sendUpdate();}));
          r3.appendChild(spanInfo(`Pred: <b>${sharedState.predictionTimeMinutes} min</b>`));
          pa.appendChild(r3);

          // Pairing BRAA
          const pp = doc.getElementById("panel-pairing");
          pp.innerHTML = `<div class="panel-header">Empareo (BRAA)</div>`;
          const rowP = divRow();
          const s1 = selectPlanes(); const s2 = selectPlanes();
          const pairBtn   = smallBtn("Parear", ()=>{
            const a=s1.value, b=s2.value; if(!a||!b||a===b) return alert("Elija 2 distintos");
            const P1=sharedState.planes.find(p=>p.originalName===a), P2=sharedState.planes.find(p=>p.originalName===b); if(!P1||!P2) return;
            const m = computePairMetrics(P1,P2);
            const exist = sharedState.studentPairings.find(x=> (x.plane1Name===a&&x.plane2Name===b)||(x.plane1Name===b&&x.plane2Name===a));
            if (!exist){
              sharedState.studentPairings.push({plane1Name:a, plane2Name:b, ...m});
              sendUpdate();
            }
          });
          const clearBtn = smallBtn("Limpiar", ()=>{ sharedState.studentPairings=[]; sendUpdate(); });
          rowP.appendChild(s1); rowP.appendChild(s2); rowP.appendChild(pairBtn); rowP.appendChild(clearBtn);
          pp.appendChild(rowP);

          const list = doc.createElement("div");
          list.className="info";
          if (sharedState.studentPairings.length===0) list.innerHTML = `<span class="badge">Sin pares</span>`;
          else {
            list.innerHTML = sharedState.studentPairings.map(p=>{
              const P1=sharedState.planes.find(x=>x.originalName===p.plane1Name);
              const P2=sharedState.planes.find(x=>x.originalName===p.plane2Name);
              const head = String(Math.round(p.relativeHeading)).padStart(3,'0')+'¬∞';
              const dist = sharedState.isMetric ? p.distanceKM.toFixed(1)+' KM' : p.distanceNM.toFixed(1)+' NM';
              const alt  = sharedState.isMetric ? (p.altitudeDiff*FT_TO_M).toFixed(0)+' m' : p.altitudeDiff.toFixed(0)+' ft';
              return `<div style="margin:6px 0">‚Ä¢ <b>${P1?.name||p.plane1Name}</b> ‚Äì <b>${P2?.name||p.plane2Name}</b> ‚Üí ${head} / ${dist} / ŒîALT ${alt}</div>`;
            }).join("");
          }
          pp.appendChild(list);
        }
      }

      // Helpers UI
      function btn(on, off, isOn){ const b=doc.createElement("button"); b.className="btn-compact"; b.textContent=isOn?off:on; return b; }
      function toggleBtn(text, active, fn){ const b=doc.createElement("button"); b.className="btn-compact"; b.textContent=text; if(active) b.classList.add("btn-highlight"); b.onclick=fn; return b; }
      function smallBtn(text, fn){ const b=doc.createElement("button"); b.className="btn-compact"; b.textContent=text; b.onclick=fn; return b; }
      function spanInfo(html){ const s=doc.createElement("span"); s.className="info"; s.innerHTML=html; return s; }
      function divRow(){ const d=doc.createElement("div"); d.className="row"; return d; }
      function inputNum(value, min, max, on, label){
        const wrap = doc.createElement("div");
        wrap.innerHTML = `<div class="info" style="margin-bottom:2px">${label}</div>`;
        const i=doc.createElement("input"); i.type="number"; i.className="btn-compact"; i.style.width="70px";
        i.min=min; i.max=max; i.value=value; i.onchange=()=>on(i.value);
        wrap.appendChild(i); return wrap;
      }
      function selectPlanes(){
        const s=doc.createElement("select"); s.className="btn-compact";
        s.innerHTML = `<option value="">Avi√≥n</option>` + sharedState.planes.map(p=>`<option value="${p.originalName}">${p.name}</option>`).join("");
        return s;
      }

      // ===== Publicaci√≥n peri√≥dica (solo Instructor) =====
      let publishTimer = null;
      if (isInstructor) {
        publishTimer = setInterval(()=> sendUpdate(), 66); // ~15 Hz
      }

      // ===== Animaci√≥n principal =====
      let last=0;
      function animate(t){
        const dt = t - last; last = t;

        // Integraci√≥n solo Instructor
        if (isInstructor && !sharedState.paused) {
          for (const p of sharedState.planes) new Plane(p).update(dt);
          updateMissiles(dt);
        }

        // Pintar
        drawScope(dt);

        // Aviones
        for (const p of sharedState.planes) new Plane(p).draw();

        // L√≠neas de empareo
        drawPairLines();

        // Misiles
        drawMissiles();

        // Regla
        drawRuler();

        requestAnimationFrame(animate);
      }

      // Redibujar UI al cambiar estado
      const fbCallback = db.ref("simulador/state").on("value", ()=> updateUI());
      updateUI();
      animate(0);

      popup.addEventListener("beforeunload", ()=>{
        if (publishTimer) clearInterval(publishTimer);
        db.ref("simulador/state").off("value", fbCallback);
      });

      // Pan y zoom (mouse izquierdo + rueda)
      let dragging=false, dragStart={x:0,y:0};
      canvas.addEventListener("mousedown", e=>{
        if (e.button===0){ dragging=true; dragStart={x:e.clientX,y:e.clientY}; }
      });
      canvas.addEventListener("mousemove", e=>{
        if (dragging){
          offsetX += (e.clientX - dragStart.x);
          offsetY += (e.clientY - dragStart.y);
          dragStart={x:e.clientX,y:e.clientY};
        }
      });
      canvas.addEventListener("mouseup", ()=> dragging=false);
      canvas.addEventListener("wheel", e=>{
        e.preventDefault();
        const factor = e.deltaY<0 ? 1.1 : (1/1.1);
        zoom *= factor;
      }, {passive:false});
    }
  </script>
</body>
</html>
