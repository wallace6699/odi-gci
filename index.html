<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Simulador de Radar y Reporte Táctico (Tiempo Real)</title>
  <style>
    body{background:#000;color:#fff;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;text-align:center;margin:0;height:100vh;overflow:hidden}
    h1{color:#90ee90;margin:14px 0}
    button{padding:6px 10px;font-size:13px;border:1px solid rgba(255,255,255,.06);border-radius:6px;cursor:pointer;background:rgba(26,92,26,.95);color:#fff;margin:4px}
    button:hover{background:rgba(40,122,40,.95)}
    .btn-compact{padding:5px 8px;font-size:12px;border-radius:5px}
    .btn-highlight{border:1px solid yellow;background:rgba(255,215,0,.3)}
    .panel{position:absolute;background:rgba(10,20,10,.85);padding:12px;border-radius:10px;border:1px solid #2f6b2f}
    .panel-header{font-weight:bold;color:#90ee90;text-align:center;margin-bottom:8px}
    canvas{display:block;position:absolute;top:0;left:0;width:100%;height:100%}
  </style>
</head>
<body>
  <h1>Simulador de Radar y Reporte Táctico</h1>
  <button id="simButton" class="btn-compact">Abrir Panel Instructor</button>
  <button id="alumnoButton" class="btn-compact">Abrir Panel Alumno</button>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <script>
    // =========================
    // Firebase
    // =========================
    const firebaseConfig = {
      apiKey: "AIzaSyDiuQsBaCoPrpjEfhYKgY649GJ5iXd0huw",
      authDomain: "odi-gci-simulador.firebaseapp.com",
      databaseURL: "https://odi-gci-simulador-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "odi-gci-simulador",
      storageBucket: "odi-gci-simulador.firebasestorage.app",
      messagingSenderId: "188901394065",
      appId: "1:188901394065:web:6ab4d0610cfd61d3582130"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // =========================
    // Estado compartido inicial
    // =========================
    const NM_TO_KM = 1.852;
    const KMH_TO_KNOTS = 0.539957;
    const FT_TO_M = 0.3048;

    const INITIAL_PLANES = [
      { name:"R1", originalName:"R1", x:-30, y:0,    heading:0,  targetHeading:0,  speedKmh:450, targetSpeedKmh:450, altitude:20000, targetAltitude:20000, maxTurnRate:2, ghosts:[], lastDetected:0 },
      { name:"R2", originalName:"R2", x:30,  y:0,    heading:45, targetHeading:45, speedKmh:450, targetSpeedKmh:450, altitude:21000, targetAltitude:21000, maxTurnRate:2, ghosts:[], lastDetected:0 },
      { name:"R3", originalName:"R3", x:0,   y:-40,  heading:90, targetHeading:90, speedKmh:500, targetSpeedKmh:500, altitude:22000, targetAltitude:22000, maxTurnRate:2.5, ghosts:[], lastDetected:0 }
    ];

    let sharedState = {
      planes: JSON.parse(JSON.stringify(INITIAL_PLANES)),
      paused: true,
      selectedPlanes: [],
      planeRoles: { "R1":"Friend","R2":"Bandit","R3":"Friend" },
      studentPairings: [],
      windSpeedKmh: 0,
      windDirectionDeg: 0,
      isMetric: false,
      missiles: [],
      radarSweepAngle: 0,
      radarSweepSpeedDegPerSec: 10,
      predictionTimeMinutes: 5,
      radarSweepEnabled: true,
      displayMode: 'digital',
      radarFailureActive: false
    };

    // Escribe TODO el estado a Firebase
    function sendUpdate() {
      db.ref("simulador/state").set(sharedState);
    }

    // Escucha cambios (Alumno y también Instructor reflejan su propio write sin problema)
    db.ref("simulador/state").on("value", snap => {
      const newState = snap.val();
      if (newState) sharedState = newState;
    });

    // =========================
    // Ventanas Instructor / Alumno
    // =========================
    document.getElementById("simButton").onclick   = () => openRadarWindow(true);
    document.getElementById("alumnoButton").onclick= () => openRadarWindow(false);

    function openRadarWindow(isInstructor) {
      const popupName = isInstructor ? "Instructor" : "Alumno";
      const popup = window.open("", popupName, "width=1400,height=900,resizable=yes,scrollbars=yes");
      if (!popup) { alert("⚠️ Habilita los pop-ups"); return; }

      const doc = popup.document;
      doc.title = `Radar ${popupName}`;
      doc.body.innerHTML = `
        <canvas id="popup-canvas"></canvas>
        ${isInstructor ? `
          <div id="panel-planes" class="panel" style="top:10px; left:10px; width:260px;"></div>
          <div id="panel-global" class="panel" style="bottom:10px; left:10px; width:320px;"></div>
        ` : `
          <div id="alumno-controls" class="panel" style="bottom:10px; left:10px; width:320px;"></div>
        `}
      `;

      const canvas = doc.getElementById("popup-canvas");
      const ctx = canvas.getContext("2d");
      let centerX, centerY, zoom = 1, offsetX = 0, offsetY = 0;

      function resizeCanvas() {
        canvas.width = popup.innerWidth;
        canvas.height = popup.innerHeight;
        centerX = canvas.width / 2;
        centerY = canvas.height / 2;
      }
      resizeCanvas();
      popup.addEventListener("resize", resizeCanvas);

      class Plane {
        constructor(data){ this.data = data; }
        update(delta){
          if (sharedState.paused) return;
          const s = this.data;
          const dt = delta/1000;

          // Velocidad hacia objetivo
          const accel = 50; // km/h por segundo
          if (s.speedKmh < s.targetSpeedKmh) s.speedKmh = Math.min(s.speedKmh + accel*dt, s.targetSpeedKmh);
          if (s.speedKmh > s.targetSpeedKmh) s.speedKmh = Math.max(s.speedKmh - accel*dt, s.targetSpeedKmh);

          // Rumbo hacia objetivo
          let diff = (s.targetHeading - s.heading + 360) % 360;
          if (diff > 180) diff -= 180*2;
          const maxTurn = s.maxTurnRate * dt; // deg/s
          s.heading += Math.max(-maxTurn, Math.min(maxTurn, diff));
          s.heading = (s.heading + 360) % 360;

          // Avance simple
          const moveNM = (s.speedKmh / NM_TO_KM) / 3600 * dt;
          s.x += Math.cos((s.heading - 90) * Math.PI/180) * moveNM;
          s.y += Math.sin((s.heading - 90) * Math.PI/180) * moveNM;
        }
        draw(){
          const s = this.data;
          const px = centerX + offsetX + s.x * zoom * 20;
          const py = centerY + offsetY + s.y * zoom * 20;

          const role = sharedState.planeRoles[s.originalName] || "Neutral";
          ctx.fillStyle = role==="Friend" ? "dodgerblue" : role==="Bandit" ? "red" : "lime";
          ctx.beginPath(); ctx.arc(px, py, 6, 0, Math.PI*2); ctx.fill();

          ctx.fillStyle = "#fff";
          ctx.font = "12px monospace";
          ctx.fillText(s.name, px+10, py-8);
          const altText = sharedState.isMetric ? `${(s.altitude*FT_TO_M)|0} m` : `${s.altitude|0} ft`;
          const spdText = sharedState.isMetric ? `${s.speedKmh|0} km/h` : `${(s.speedKmh*KMH_TO_KNOTS)|0} kts`;
          ctx.fillText(`${altText}  ${spdText}`, px+10, py+8);

          // Si está seleccionado, mostrar línea de proa + predicción
          if (sharedState.selectedPlanes.includes(s.originalName)) {
            const hdg = (s.heading - 90) * Math.PI/180;
            ctx.strokeStyle = "yellow"; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.moveTo(px, py); ctx.lineTo(px + Math.cos(hdg)*25, py + Math.sin(hdg)*25); ctx.stroke();

            const predSec = (sharedState.predictionTimeMinutes || 0)*60;
            if (predSec > 0) {
              const distNM = (s.speedKmh / NM_TO_KM)/3600 * predSec;
              const tx = s.x + Math.cos(hdg)*distNM;
              const ty = s.y + Math.sin(hdg)*distNM;
              const tpx = centerX + offsetX + tx * zoom * 20;
              const tpy = centerY + offsetY + ty * zoom * 20;
              ctx.setLineDash([5,5]); ctx.strokeStyle="cyan";
              ctx.beginPath(); ctx.moveTo(px, py); ctx.lineTo(tpx, tpy); ctx.stroke();
              ctx.setLineDash([]);
            }
          }
        }
      }

      let planes = sharedState.planes.map(p => new Plane(p));

      // ================
      // Controles UI
      // ================
      function updateUI(){
        if (isInstructor) {
          // Lista de aviones + selección
          const pPanel = doc.getElementById("panel-planes");
          pPanel.innerHTML = `<div class="panel-header">Aviones</div>`;
          sharedState.planes.forEach(p => {
            const b = doc.createElement("button");
            b.className = "btn-compact";
            b.textContent = `${p.name} (${sharedState.planeRoles[p.originalName]||'Neutral'})`;
            if (sharedState.selectedPlanes.includes(p.originalName)) b.classList.add("btn-highlight");
            b.onclick = () => {
              const i = sharedState.selectedPlanes.indexOf(p.originalName);
              if (i>=0) sharedState.selectedPlanes.splice(i,1);
              else sharedState.selectedPlanes.push(p.originalName);
              sendUpdate(); updateUI();
            };
            pPanel.appendChild(b);
          });

          // Controles globales básicos
          const g = doc.getElementById("panel-global");
          g.innerHTML = `<div class="panel-header">Controles Globales</div>`;

          const start = doc.createElement("button");
          start.className = "btn-compact";
          start.textContent = sharedState.paused ? "▶️ Iniciar" : "⏸️ Pausar";
          start.onclick = ()=>{ sharedState.paused = !sharedState.paused; sendUpdate(); };
          g.appendChild(start);

          const metric = doc.createElement("button");
          metric.className="btn-compact"; metric.textContent="Métrico";
          if (sharedState.isMetric) metric.classList.add("btn-highlight");
          metric.onclick=()=>{sharedState.isMetric=true; sendUpdate();};
          g.appendChild(metric);

          const imperial = doc.createElement("button");
          imperial.className="btn-compact"; imperial.textContent="Imperial";
          if (!sharedState.isMetric) imperial.classList.add("btn-highlight");
          imperial.onclick=()=>{sharedState.isMetric=false; sendUpdate();};
          g.appendChild(imperial);

          const analog = doc.createElement("button");
          analog.className="btn-compact"; analog.textContent="Analógico";
          if (sharedState.displayMode==='analog') analog.classList.add("btn-highlight");
          analog.onclick=()=>{sharedState.displayMode='analog'; sendUpdate();};
          g.appendChild(analog);

          const digital = doc.createElement("button");
          digital.className="btn-compact"; digital.textContent="Digital";
          if (sharedState.displayMode==='digital') digital.classList.add("btn-highlight");
          digital.onclick=()=>{sharedState.displayMode='digital'; sendUpdate();};
          g.appendChild(digital);

          const haz = doc.createElement("button");
          haz.className="btn-compact"; haz.textContent = sharedState.radarSweepEnabled ? "Haz ON" : "Haz OFF";
          if (sharedState.radarSweepEnabled) haz.classList.add("btn-highlight");
          haz.onclick=()=>{sharedState.radarSweepEnabled=!sharedState.radarSweepEnabled; sendUpdate();};
          g.appendChild(haz);

          // Predicción
          const menos = doc.createElement("button");
          menos.className="btn-compact"; menos.textContent="- Pred";
          menos.onclick=()=>{sharedState.predictionTimeMinutes=Math.max(0,(sharedState.predictionTimeMinutes||0)-1); sendUpdate();};
          const mas = doc.createElement("button");
          mas.className="btn-compact"; mas.textContent="+ Pred";
          mas.onclick=()=>{sharedState.predictionTimeMinutes=Math.min(60,(sharedState.predictionTimeMinutes||0)+1); sendUpdate();};
          g.appendChild(menos); g.appendChild(mas);

        } else {
          // Alumno: solo visibilidad (localmente compartida)
          const c = doc.getElementById("alumno-controls");
          c.innerHTML = `<div class="panel-header">Controles de Visibilidad</div>`;

          const metric = doc.createElement("button");
          metric.className="btn-compact"; metric.textContent="Métrico";
          if (sharedState.isMetric) metric.classList.add("btn-highlight");
          metric.onclick=()=>{sharedState.isMetric=true; sendUpdate();};
          c.appendChild(metric);

          const imperial = doc.createElement("button");
          imperial.className="btn-compact"; imperial.textContent="Imperial";
          if (!sharedState.isMetric) imperial.classList.add("btn-highlight");
          imperial.onclick=()=>{sharedState.isMetric=false; sendUpdate();};
          c.appendChild(imperial);

          const analog = doc.createElement("button");
          analog.className="btn-compact"; analog.textContent="Analógico";
          if (sharedState.displayMode==='analog') analog.classList.add("btn-highlight");
          analog.onclick=()=>{sharedState.displayMode='analog'; sendUpdate();};
          c.appendChild(analog);

          const digital = doc.createElement("button");
          digital.className="btn-compact"; digital.textContent="Digital";
          if (sharedState.displayMode==='digital') digital.classList.add("btn-highlight");
          digital.onclick=()=>{sharedState.displayMode='digital'; sendUpdate();};
          c.appendChild(digital);

          const haz = doc.createElement("button");
          haz.className="btn-compact"; haz.textContent = sharedState.radarSweepEnabled ? "Haz ON" : "Haz OFF";
          if (sharedState.radarSweepEnabled) haz.classList.add("btn-highlight");
          haz.onclick=()=>{sharedState.radarSweepEnabled=!sharedState.radarSweepEnabled; sendUpdate();};
          c.appendChild(haz);

          const menos = doc.createElement("button");
          menos.className="btn-compact"; menos.textContent="- Pred";
          menos.onclick=()=>{sharedState.predictionTimeMinutes=Math.max(0,(sharedState.predictionTimeMinutes||0)-1); sendUpdate();};
          const mas = doc.createElement("button");
          mas.className="btn-compact"; mas.textContent="+ Pred";
          mas.onclick=()=>{sharedState.predictionTimeMinutes=Math.min(60,(sharedState.predictionTimeMinutes||0)+1); sendUpdate();};
          c.appendChild(menos); c.appendChild(mas);
        }
      }

      // ================
      // Publicación periódica (tiempo real)
      // ================
      let publishTimer = null;
      if (isInstructor) {
        // Publica 15 Hz (≈ cada 66 ms). Suficientemente fluido y eficiente.
        publishTimer = setInterval(() => {
          sendUpdate();
        }, 66);
      }

      // ================
      // Animación
      // ================
      let last = 0;
      function animate(t){
        const dt = t - last; last = t;

        // Solo el Instructor integra movimiento; Alumno solo dibuja lo que lee
        if (isInstructor && !sharedState.paused) {
          // Integrar dinámica simple de todos los aviones
          for (const p of sharedState.planes) {
            // (pequeña conversión a clase para reutilizar lógica)
            new Plane(p).update(dt);
          }
        }

        // Redibujar
        ctx.fillStyle = "black";
        ctx.fillRect(0,0,canvas.width,canvas.height);

        // Reconstituir objetos de dibujo (ligeros) y pintar
        planes = sharedState.planes.map(p => new Plane(p));
        planes.forEach(p => p.draw());

        // Barrido radar (estético)
        if (sharedState.radarSweepEnabled) {
          sharedState.radarSweepAngle = (sharedState.radarSweepAngle + sharedState.radarSweepSpeedDegPerSec * (dt/1000)) % 360;
          const sweepAngleRad = sharedState.radarSweepAngle * Math.PI/180;
          const r = Math.max(canvas.width, canvas.height);
          ctx.save();
          ctx.translate(centerX, centerY);
          ctx.rotate(sweepAngleRad);
          const grad = ctx.createRadialGradient(0,0,0,0,0,r);
          grad.addColorStop(0,'rgba(255,165,0,0.05)');
          grad.addColorStop(0.5,'rgba(255,165,0,0.15)');
          grad.addColorStop(1,'rgba(255,165,0,0.3)');
          ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,r,0,Math.PI/8); ctx.closePath();
          ctx.fillStyle = grad; ctx.fill();
          ctx.restore();
        }

        requestAnimationFrame(animate);
      }

      // Refresca UI cuando cambie el estado (listener global ya actualiza sharedState)
      const fbUnsub = db.ref("simulador/state").on("value", () => { updateUI(); });

      updateUI();
      animate(0);

      popup.addEventListener("beforeunload", () => {
        if (publishTimer) clearInterval(publishTimer);
        db.ref("simulador/state").off("value", fbUnsub);
      });
    }
  </script>
</body>
</html>
